<!doctype html>
<html lang="en" data-version="{{ uuid }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NullTrace â€¢ Quantum-Ready E2EE Chat</title>
  <meta name="description" content="NullTrace â€” quantum-ready, RAM-only group chat with hybrid X25519 + ML-KEM, deterministic AEAD, chaff traffic shaping, and zero telemetry.">
  <meta name="color-scheme" content="dark light">
  <meta name="theme-color" content="#0d0f14">
  <link rel="icon" href="{{ url_for('static', path='logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">

  <!-- Import map (local vendor bundles). Nonce matches CSP from backend. -->
  <script type="importmap" nonce="{{ request.state.csp_nonce }}">
  {
    "imports": {
      "libsodium-wrappers": "https://esm.sh/libsodium-wrappers@0.7.15?bundle",
      "mlkem":              "https://esm.sh/mlkem@2.3.1?bundle",
      "handshake":          "/static/js/modules/handshake.js?v={{ uuid }}",
      "group":              "/static/js/modules/group.js?v={{ uuid }}",
      "mls":                "/static/js/modules/mls.js?v={{ uuid }}",
      "nacp":               "/static/js/modules/nacp.js?v={{ uuid }}"
    }
  }
  </script>
</head>
<body>
  <main class="container">

    <!-- TOP BAR -->
    <header class="topbar">
      <div class="brand">
        <img src="{{ url_for('static', path='logo.png') }}" class="logo" alt="NullTrace logo" decoding="async">
        <div class="brand-copy">
          <h1 class="app-title">NullTrace</h1>
          <p class="app-sub">Quantum-ready â€¢ RAM-only â€¢ Zero telemetry</p>
        </div>
      </div>
      <div class="status-badges">
        <span class="badge">E2EE</span>
        <span class="badge">PQ-Hybrid</span>
        <span class="badge">No Logs</span>
        <span id="status" class="badge badge-live" aria-live="polite"></span>
      </div>
    </header>

    <!-- HERO -->
    <section class="hero">
      <div class="hero-card">
        <h2>Private rooms. Disposable identities.</h2>
        <p class="muted">Spin up a secure channel, invite with a one-time capsule, and let messages auto-burn.</p>

        <div class="quick-actions">
          <input id="room" class="room-input" inputmode="latin" autocomplete="off" spellcheck="false" placeholder="Secure Channel">
          <div class="actions">
            <button id="join" class="btn primary">Start</button>
            <button id="capsuleBtn" class="btn">Join</button>
            <button id="inviteBtn" class="btn ghost" disabled>Invite</button>
          </div>
        </div>

        <ul class="hero-points">
          <li>ğŸ” Post-quantum hybrid keying</li>
          <li>ğŸ•µï¸ Traffic shaping with chaff & padding</li>
          <li>ğŸ§¨ Burn timer â€¢ âš°ï¸ Deadman â€¢ One-click wipe</li>
        </ul>
      </div>
    </section>

    <!-- PENDING APPROVALS -->
    <section class="pending" aria-labelledby="pending-title">
      <h3 id="pending-title" class="visually-hidden">Pending approvals</h3>
      <ul id="pendingList" class="pending-list"></ul>
    </section>

    <!-- MAIN GRID: CHAT + PARTICIPANTS -->
    <section class="grid" aria-label="Chat">
      <div class="chat-shell">
        <ul id="messages" class="chat" aria-live="polite" aria-relevant="additions"></ul>
      </div>

      <aside class="roster" aria-labelledby="roster-title">
        <div class="roster-head">
          <h3 id="roster-title">Participants</h3>
          <p class="muted small">Approve newcomers â€¢ verify fingerprints</p>
        </div>
        <div id="userList" class="user-list"></div>
      </aside>
    </section>

    <!-- BOTTOM BAR -->
    <section class="bottom-bar" aria-label="Compose">
      <div class="compose">
        <input id="input" class="compose-input" placeholder="Type your secure messageâ€¦" disabled autocomplete="off" spellcheck="false">
        <button id="send" class="btn primary" disabled>Send</button>
      </div>
      <div class="controls">
        <button id="disconnectBtn" class="btn danger" disabled title="Wipe session">Wipe</button>
        <label class="deadman-label" title="Hide tab &gt;2â€‰s to wipe">
          <input type="checkbox" id="deadmanToggle" disabled>
          Deadman
        </label>
      </div>
    </section>

    <!-- SECURITY ENGINE -->
    <section class="features" aria-labelledby="engine-title">
      <h2 id="engine-title">ğŸ§¬ Security Engine</h2>

      <div class="feature-grid">
        <div class="feature">
          <h4>ğŸ” PQ-Hybrid from day one</h4>
          <p>X25519 + ML-KEM-512 for long-term secrecy and post-quantum resilience.</p>
        </div>

        <div class="feature">
          <h4>ğŸ†” Identity-bound pairing</h4>
          <p>Signed handshake transcript + short SAS check to kill invisible MITM.</p>
        </div>

        <div class="feature">
          <h4>ğŸ§± Replay-proof AEAD</h4>
          <p>XChaCha20-Poly1305 with per-sender sequence &amp; epochs. Strict AAD binds sender/seq/epoch.</p>
        </div>

        <div class="feature">
          <h4>ğŸ”„ Smart rekey</h4>
          <p>Initiator-driven rekey on join/leave (debounced). Per-peer sealed GK distribution.</p>
        </div>

        <div class="feature">
          <h4>ğŸ« Access capsules</h4>
          <p>NT-C1 invites: signed, TTL-locked, size-padded. One-time room tokens at the WS edge.</p>
        </div>

        <div class="feature">
          <h4>ğŸ•µï¸ Traffic shaping</h4>
          <p>Uniform 3â€“5â€‰KB frames; encrypted chaff runs constantly; server sinks noise.</p>
        </div>

        <div class="feature">
          <h4>ğŸ›¡ï¸ Soft rate limits</h4>
          <p>Per-class quotas (chat / control / bulk). No rage-disconnects; just gentle back-pressure.</p>
        </div>

        <div class="feature">
          <h4>ğŸ§  RAM-only</h4>
          <p>No persistence, no telemetry. Hardened headers &amp; CSP by default.</p>
        </div>

        <div class="feature">
          <h4>ğŸ§¨ Safety UX</h4>
          <p>Pending approvals, SAS verify, burn timer, deadman switch, one-tap wipe.</p>
        </div>
      </div>
    </section>

    <!-- HOW IT WORKS -->
    <section class="features" aria-labelledby="how-title">
      <h2 id="how-title">âš™ï¸ How it works</h2>

      <ol class="how-list">
        <li><strong>Host starts a room.</strong> Fresh keys; disposable room ID.</li>
        <li><strong>Share an invite capsule.</strong> Signed NT-C1, TTL-bound, size-padded (no token inside).</li>
        <li><strong>Guest pastes &amp; confirms.</strong> Room + short SAS fingerprints for a quick human check.</li>
        <li><strong>Hybrid handshake.</strong> X25519 + ML-KEM derive a shared secret; initiator signs the transcript.</li>
        <li><strong>Host approves.</strong> Sends one-shot <code>ct</code>; rekeys and distributes sealed GK to members.</li>
        <li><strong>Chat.</strong> AEAD with deterministic nonces; AAD over <code>{type,cid,seq,epoch}</code>.</li>
        <li><strong>Membership changes = new keys.</strong> Debounced rekey; guests can <code>gk_req</code> to resync.</li>
        <li><strong>Traffic gets blended.</strong> Frames are padded; encrypted chaff runs; server sinks the noise.</li>
        <li><strong>Clean exit.</strong> Burn timer, deadman, wipe. Nothing at rest.</li>
      </ol>
    </section>

  </main>

  <!-- INVITE DIALOG -->
  <dialog id="inviteDlg" class="dlg" aria-labelledby="invite-title">
    <h3 id="invite-title">Share capsule</h3>
    <p class="muted small">Expires in <span id="inviteTimer">02:00</span></p>
    <textarea id="inviteTxt" readonly class="mono" rows="5"></textarea>
    <div class="dlg-buttons">
      <button id="inviteCloseBtn" class="btn">Close</button>
    </div>
  </dialog>

  <!-- PASTE CAPSULE DIALOG -->
  <dialog id="pasteDlg" class="dlg" aria-labelledby="paste-title">
    <h3 id="paste-title">Paste capsule</h3>
    <textarea id="pasteTxt" class="mono" rows="5" placeholder="Paste NT-C1 capsule hereâ€¦"></textarea>
    <div class="dlg-buttons">
      <button id="pasteOk" class="btn primary">OK</button>
      <button id="pasteCancelBtn" class="btn" onclick="this.closest('dialog').close()">Cancel</button>
    </div>
  </dialog>

  <!-- CONFIRM JOIN DIALOG -->
  <dialog id="confirmDlg" class="dlg" aria-labelledby="confirm-title">
    <h3 id="confirm-title">Confirm Join</h3>
    <div class="confirm-grid">
      <p>Room: <strong><span id="confirmRoom"></span></strong></p>
      <p>Host ID: <code id="confirmHostFP"></code></p>
      <p>Your ID: <code id="confirmGuestFP"></code></p>
    </div>
    <div class="dlg-buttons">
      <button id="confirmJoinBtn" class="btn primary">Join</button>
      <button id="confirmCancelBtn" class="btn">Cancel</button>
    </div>
  </dialog>

  <noscript>
    <p class="muted small" style="text-align:center;margin:1rem 0;">
      JavaScript is required for end-to-end encryption.
    </p>
  </noscript>

  <!-- App -->
  <script type="module" src="{{ url_for('static', path='js/app.js') }}?v={{ uuid }}"></script>
</body>
</html>
